name: Dry-run release build (manual)

on:
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build-release-dry-run:
        runs-on: ubuntu-latest
        env:
            PLUGIN_SLUG: costered-blocks
            ZIP_NAME: costered-blocks.zip

        steps:
        -   name: Checkout
            uses: actions/checkout@v4

        -   name: Setup Node
            uses: actions/setup-node@v4
            with:
                node-version: '20'
                cache: 'npm'

        -   name: Setup PHP
            uses: shivammathur/setup-php@v2
            with:
                php-version: '8.2'
                tools: composer
                coverage: none

        -   name: Install PHP dependencies (Composer)
            run: composer install --no-dev --prefer-dist --optimize-autoloader

        -   name: Install dependencies
            run: npm ci

        -   name: Run Jest tests
            run: npm test

        -   name: Build assets
            env:
                NODE_ENV: production
            run: npm run build

        -   name: Create plugin zip (release-equivalent)
            run: |
                set -euxo pipefail

                WORKDIR="${GITHUB_WORKSPACE}"
                STAGING_DIR="/tmp/${PLUGIN_SLUG}"

                rm -rf "${STAGING_DIR}"
                mkdir -p "${STAGING_DIR}"

                # 1) Export tracked files, honouring .gitattributes export-ignore
                git archive --format=tar HEAD | tar -x -C "${STAGING_DIR}"

                # 2) Overlay built assets
                for dir in js css; do
                    if [ -d "${WORKDIR}/${dir}" ]; then
                        rm -rf "${STAGING_DIR}/${dir}"
                        cp -a "${WORKDIR}/${dir}" "${STAGING_DIR}/${dir}"
                    fi
                done

                # 3) Overlay vendor directory
                if [ -d "${WORKDIR}/vendor" ]; then
                    rm -rf "${STAGING_DIR}/vendor"
                    cp -a "${WORKDIR}/vendor" "${STAGING_DIR}/vendor"
                fi

                echo "Built /tmp/${ZIP_NAME}"
                
        -   name: Wrap plugin folder for artefact root
            run: |
                set -euxo pipefail

                rm -rf /tmp/upload-root
                mkdir -p /tmp/upload-root

                rm -rf "/tmp/${PLUGIN_SLUG}"
                mv "/tmp/${PLUGIN_SLUG}" "/tmp/upload-root/${PLUGIN_SLUG}"

        -   name: Upload upload-ready artefact
            uses: actions/upload-artifact@v4
            with:
                name: costered-blocks
                path: /tmp/upload-root/*