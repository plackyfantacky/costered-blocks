name: Test build plugin (no publishing)

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

permissions:
    contents: read

jobs:
    build-develop:
        runs-on: ubuntu-latest
        env:
            PLUGIN_SLUG: costered-blocks
            ZIP_NAME: costered-blocks-dev.zip
            SHORT_SHA: dev

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup Node
                uses: actions/setup-node@v4
                with:
                    node-version: '20'
                    cache: 'npm'
            
            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.2'
                    tools: composer
                    coverage: none

            -   name: Install PHP dependencies (Composer)
                run: composer install --no-dev --prefer-dist --optimize-autoloader

            -   name: Install dependencies
                run: npm ci

            -   name: Run Jest tests
                run: npm test

            -   name: Build assets
                env:
                    NODE_ENV: production
                run: npm run build

            -   name: Compute short commit hash
                run: |
                    set -euxo pipefail
                    SHORT_SHA="$(git rev-parse --short=7 HEAD)"
                    echo "SHORT_SHA=${SHORT_SHA}" >> "${GITHUB_ENV}"

            -   name: Create plugin zip (git archive + compiled assets)
                run: |
                    set -euxo pipefail

                    WORKDIR="${GITHUB_WORKSPACE}"
                    STAGING_DIR="/tmp/${PLUGIN_SLUG}"

                    rm -rf "${STAGING_DIR}"
                    mkdir -p "${STAGING_DIR}"

                    # Copy everything from the repo, ignoring only obvious junk
                    rsync -a \
                        --exclude '.git' \
                        --exclude '.github' \
                        --exclude 'node_modules' \
                        "${WORKDIR}/" "${STAGING_DIR}/"

                    echo "Prepared plugin folder at ${STAGING_DIR}"

            -   name: Wrap plugin folder for artefact root
                run: |
                    set -euxo pipefail

                    rm -rf /tmp/artifact-root
                    mkdir -p /tmp/artifact-root

                    # We want the artefact zip to contain a top-level "costered-blocks/" folder.
                    mv "/tmp/${PLUGIN_SLUG}" "/tmp/artifact-root/${PLUGIN_SLUG}"

            -   name: Upload plugin zip artefact
                uses: actions/upload-artifact@v4
                with:
                    name: costered-blocks-${{ env.SHORT_SHA }}
                    path: "/tmp/artifact-root"