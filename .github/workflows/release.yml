name: Build release on tag

on:
    push:
        tags:
            - 'v*'

permissions:
    contents: write

jobs:
    build-release:
        runs-on: ubuntu-latest

        steps:
        -   name: Checkout
            uses: actions/checkout@v4

        -   name: Setup Node
            uses: actions/setup-node@v4
            with:
                node-version: '20'
                cache: 'npm'

        -   name: Install dependencies
            run: npm ci

        -   name: Run Jest tests
            run: npm test

        -   name: Check tag version matches package.json
            run: |
                set -euxo pipefail
                TAG="${GITHUB_REF_NAME}"        # e.g. v1.3.2
                TAG_VERSION="${TAG#v}"
                PKG_VERSION=$(node -p "require('./package.json').version")

                echo "Tag version: ${TAG_VERSION}, package.json: ${PKG_VERSION}"

                if [ "${TAG_VERSION}" != "${PKG_VERSION}" ]; then
                    echo "Version mismatch: tag is v${TAG_VERSION}, package.json is ${PKG_VERSION}"
                    exit 1
                fi

        -   name: Build assets
            env:
                NODE_ENV: production
            run: npm run build

        -   name: Create plugin zip (git archive + compiled assets)
            run: |
                set -euxo pipefail

                PLUGIN_SLUG="costered-blocks"
                WORKDIR="${GITHUB_WORKSPACE}"
                STAGING_DIR="/tmp/${PLUGIN_SLUG}"

                rm -rf "${STAGING_DIR}"
                mkdir -p "${STAGING_DIR}"

                # 1) Export tracked files, honouring .gitattributes export-ignore
                git archive --format=tar HEAD | tar -x -C "${STAGING_DIR}"

                # 2) Overlay built assets from the working tree (js and css are generated)
                for dir in js css; do
                    if [ -d "${WORKDIR}/${dir}" ]; then
                        rm -rf "${STAGING_DIR}/${dir}"
                        cp -a "${WORKDIR}/${dir}" "${STAGING_DIR}/${dir}"
                    fi
                done

                # 3) Create the final plugin zip next to the staging dir
                cd "$(dirname "${STAGING_DIR}")"
                zip -rq "${PLUGIN_SLUG}.zip" "${PLUGIN_SLUG}"

                
        -   name: Upload plugin zip artefact
            uses: actions/upload-artifact@v4
            with:
                name: costered-blocks-plugin
                path: /tmp/costered-blocks.zip


        -   name: Create GitHub Release
            uses: softprops/action-gh-release@v2
            with:
                tag_name: ${{ github.ref_name }}
                files: /tmp/costered-blocks.zip
                generate_release_notes: true
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
